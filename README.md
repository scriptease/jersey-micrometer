# Jersey Micrometer

[![Build Status](https://travis-ci.com/stefanbirkner/jersey-micrometer.svg?branch=master)](https://travis-ci.com/stefanbirkner/jersey-micrometer)

Jersey Micrometer uses [Jersey 1](https://jersey.java.net/),
[Micrometer](https://micrometer.io/) and
[Guice](https://github.com/google/guice) to simplify gathering metrics for your
JAX-RS resource methods.

Jersey Micrometer is published under the
[Apache Software License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0).
It requires at least Java 8.

Jersey Micrometer is a port of [Marshall Pierce](https://mpierce.org/)'s
[jersey-metrics-filter](https://github.com/palominolabs/jersey-metrics-filter)
library which uses [Metrics](https://metrics.dropwizard.io) instead of
Micrometer.


## Installation

Jersey Micrometer is available from
[Maven Central](https://search.maven.org/#search|ga|1|jersey-micrometer).

    <dependency>
      <groupId>com.github.stefanbirkner</groupId>
      <artifactId>jersey-micrometer</artifactId>
      <version>unpublished</version>
    </dependency>


## Usage

If you have a resource class like this:
```
@Path("whatever")
public class SomeResource {
    @GET
    public String get() {
        return "some data";
    }
}
```

then by using this library you will get a [Timer](https://micrometer.io/docs/concepts#_timers) metric generated for the `get()` method, as well as [Counters](https://micrometer.io/docs/concepts#_counters) for each status code returned by `get()`. In this case, `get()` only returns 200, so you would have one counter for status code 200.

### Installation

The first step is to add this library's module and its prerequisites.
- `ResourceMethodMicrometerModule` is the module for this library.
- `ResourceMethodWrappedDispatchModule` is needed so that method invocation times can be captured without resorting to thread locals or other such unpleasantness.
- `ConfigModuleBuilder` is used to assemble the config sources for [config-inject](https://github.com/palominolabs/config-inject). If you just want the defaults used, you need not provide any config sources, so you can just call build() as shown. See [JerseyMicrometerConfig](https://github.com/stefanbirkner/jersey-micrometer-filter/blob/master/src/main/java/com/palominolabs/metrics/jersey/JerseyMicrometerConfig.java) for more.
- We also bind a MeterRegistry instance. The binding uses a binding annotation because it's impolite for a library to insist on an un-qualified binding of a common type like MeterRegistry. This MeterRegistry instance is what will be used to house all metrics generated by the library.

```
// in your Guice module
@Override
protected void configure() {
    install(new ResourceMethodMicrometerModule());

    // required for resource method metrics
    install(new ResourceMethodWrappedDispatchModule());
    install(new ConfigModuleBuilder().build());

    MetricRegistry registry = new SimpleMeterRegistry();
    bind(MeterRegistry.class).annotatedWith(JerseyResourceMicrometer.class).toInstance(registry);

    ...
```

Next, you'll want to make sure you're providing init params to the `GuiceContainer` servlet that provides Jersey/Guice integration so that http status codes can be captured. `HttpStatusCodeCounterResourceFilterFactory` registers a Jersey container response filter that feeds outgoing HTTP status codes to the appropriate counters.
```
// in your Guice module
...
final Map<String, String> initParams = new HashMap<>();
initParams.put(ResourceConfig.PROPERTY_RESOURCE_FILTER_FACTORIES,
    HttpStatusCodeCounterResourceFilterFactory.class.getCanonicalName());

install(new ServletModule() {
    @Override
    protected void configureServlets() {
        serve("/*").with(GuiceContainer.class, initParams);
    }
}
...
});
```
### Configuration

At this point, you should now be getting metrics generated for every resource method. If you want to use annotations to have more control, you can use [`@ResourceMetrics`](https://github.com/stefanbirkner/jersey-micrometer-filter/blob/master/src/main/java/com/palominolabs/metrics/jersey/ResourceMetrics.java) to turn both timing and status code counters off and on for a class or method. In this case below, the method would end up having a timer metric but no status code counters.
```
@Path("somewhere")
@ResourceMetrics(statusCodeCounter = true, timer = false)
public class EnabledOnClassDisabledOnMethod {
    // method annotation overrides class annotation
    @GET
    @ResourceMetrics(statusCodeCounter = false, timer = true)
    public String get() {
        return "ok";
    }
}
```

You can also make it so that the default is to *not* create metrics for un-annotated classes and methods by setting the properties used in [JerseyMicrometerConfig](https://github.com/stefanbirkner/jersey-micrometer-filter/blob/master/src/main/java/com/palominolabs/metrics/jersey/JerseyMicrometerConfig.java). You can do this via the `ConfigModuleBuilder`'s config stack. Here, we'll use a simple in-code Map to define properties.

```
Map<String, Object> config = new HashMap<>();
config.put("com.palominolabs.jersey.metrics.resourceMethod.timer.enabledByDefault", "false");

ConfigModuleBuilder builder = new ConfigModuleBuilder();
// read from a map
builder.addConfiguration(new MapConfiguration(config));
```

## Development Guide

Jersey Micrometer is build with [Maven](https://maven.apache.org/). If you want
to contribute code then

* Please write a test for your change.
* Ensure that you didn't break the build by running `./mvnw verify -Dgpg.skip`.
* Fork the repo and create a pull request. (See
[Understanding the GitHub Flow](https://guides.github.com/introduction/flow/index.html))

The basic coding style is described in the
[EditorConfig](http://editorconfig.org/) file `.editorconfig`.

Jersey Micrometer supports [Travis CI](https://travis-ci.com/) for continuous
integration. Your pull request will be automatically build by Travis CI.


## Release Guide

* Select a new version according to the
  [Semantic Versioning 2.0.0 Standard](http://semver.org/).
* Set the new version in `pom.xml` and in the `Installation` section of
  this readme.
* Commit the modified `pom.xml` and `README.md`.
* Run `./mvnw clean deploy` with JDK 8.
* Add a tag for the release: `git tag jersey-micrometer-X.X.X`
